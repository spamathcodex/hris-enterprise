<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>HRIS Employee Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f4f6f9;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 400px;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: 0.2s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f1c40f;
            color: #333;
            margin-top: 10px;
        }

        .nav-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .nav-tab {
            flex: 1;
            padding: 10px;
            cursor: pointer;
            color: #777;
            font-weight: bold;
        }

        .nav-tab.active {
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 5px;
        }
    </style>
</head>

<body>

    <div id="login-screen" class="card">
        <h2>üîê Login Karyawan</h2>
        <input type="email" id="email" placeholder="Email Kantor">
        <input type="password" id="password" placeholder="Password">
        <button class="btn-primary" onclick="login()">Masuk Sistem</button>
        <p id="error-msg" style="color: red; margin-top: 10px;"></p>
    </div>

    <div id="dashboard-screen" class="card hidden" style="width: 500px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">Halo, <span id="user-name">User</span>! üëã</h2>
            <button onclick="logout()"
                style="width: auto; background: transparent; color: #e74c3c; border: 1px solid #e74c3c; padding: 5px 10px;">Logout</button>
        </div>

        <a id="btn-admin" href="admin.html" class="hidden"
            style="display:block; background:#6f42c1; color:white; text-decoration:none; padding:10px; border-radius:5px; margin-bottom:10px; font-weight:bold;">üëÆ
            HRD Dashboard</a>
        <a id="btn-manager" href="manager.html"
            style="display:block; background:#f39c12; color:white; text-decoration:none; padding:10px; border-radius:5px; margin-bottom:15px; font-weight:bold;">üì•
            Inbox Approval Cuti</a>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('absensi')">üìÖ Absensi</div>
            <div class="nav-tab" onclick="switchTab('cuti')">üèñÔ∏è Pengajuan Cuti</div>
            <div class="nav-tab" onclick="switchTab('gaji')">üí∞ Slip Gaji</div>
        </div>

        <div id="tab-absensi">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="btn-primary" onclick="kirimAbsen('clock-in')">üåû MASUK</button>
                <button class="btn-danger" onclick="kirimAbsen('clock-out')">üåô PULANG</button>
            </div>
            <p id="absen-status" style="font-weight:bold; height: 20px;"></p>

            <h3 style="text-align: left; font-size: 16px; margin-top: 20px;">Riwayat Terakhir</h3>
            <table style="width:100%; font-size: 13px; text-align: left;">
                <tbody id="history-table"></tbody>
            </table>
        </div>

        <div id="tab-cuti" class="hidden">
            <div style="text-align: left; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top:0; font-size:16px;">‚úàÔ∏è Form Pengajuan</h3>
                <label>Mulai Tanggal:</label>
                <input type="date" id="leave-start">
        
                <label>Sampai Tanggal:</label>
                <input type="date" id="leave-end">
        
                <label>Alasan:</label>
                <textarea id="leave-reason" placeholder="Contoh: Liburan keluarga / Sakit" rows="2"></textarea>
        
                <button class="btn-warning" onclick="submitLeave()">Kirim Permohonan</button>
                <p id="leave-status" style="margin-top: 10px; font-size: 14px;"></p>
            </div>
        
            <h3 style="text-align: left; font-size: 16px;">üìÇ Riwayat Pengajuan Saya</h3>
            <table style="width:100%; font-size: 13px; text-align: left; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #ddd;">
                        <th style="padding:5px;">Tanggal</th>
                        <th style="padding:5px;">Alasan</th>
                        <th style="padding:5px;">Status</th>
                    </tr>
                </thead>
                <tbody id="leave-history-table">
                </tbody>
            </table>
        </div>

        <div id="tab-gaji" class="hidden">
            <h3>Riwayat Penghasilan</h3>
            <table style="width:100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="background: #f1f1f1;">
                        <th style="padding:8px; text-align:left;">Periode</th>
                        <th style="padding:8px; text-align:right;">Gaji Bersih (THP)</th>
                        <th style="padding:8px; text-align:center;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="payroll-table">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('hris_token');
        if (token) showDashboard(localStorage.getItem('hris_name'), localStorage.getItem('hris_role'));

        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            fetch('https://hris-enterprise-production.up.railway.app//api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.token) {
                        localStorage.setItem('hris_token', data.token);
                        localStorage.setItem('hris_name', data.name);
                        localStorage.setItem('hris_role', data.role);
                        showDashboard(data.name, data.role);
                    } else {
                        document.getElementById('error-msg').innerText = data.error;
                    }
                });
        }

        function showDashboard(name, role) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');
            document.getElementById('user-name').innerText = name;

            // --- PERBAIKAN SECURITY TOMBOL ---
            const btnAdmin = document.getElementById('btn-admin');
            const btnManager = document.getElementById('btn-manager');

            // Default: Sembunyikan Dulu Semuanya
            btnAdmin.style.display = 'none';
            btnManager.style.display = 'none';

            // Cek Role (Pastikan huruf besar/kecil cocok)
            if (role === 'ADMIN') {
                btnAdmin.style.display = 'block';   // Hanya Admin yg boleh lihat
                btnManager.style.display = 'block'; // Admin juga yg approve cuti
            }

            // Semua orang bisa jadi Manager (jika punya bawahan), jadi kita tampilkan saja tombolnya.
            // (Idealnya kita cek di backend apakah dia manager, tapi ini shortcut)

            loadHistory();
        }

        // --- FUNGSI TAB ---
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Sembunyikan semua tab
            document.getElementById('tab-absensi').classList.add('hidden');
            document.getElementById('tab-cuti').classList.add('hidden');
            document.getElementById('tab-gaji').classList.add('hidden');

            // Munculkan yang dipilih
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            if (tabName === 'cuti') {
                loadLeaveHistory(); // Agar riwayat muncul tanpa harus submit dulu
            }
            else if (tabName === 'gaji') {
                loadPayroll();      // Agar slip gaji muncul saat tab dibuka
            }
            else if (tabName === 'absensi') {
                loadHistory();      // Refresh absensi juga biar update
            }        }

        // FUNGSI LOAD SLIP GAJI
        function loadPayroll() {
            fetch('https://hris-enterprise-production.up.railway.app//api/payroll/my-history', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('payroll-table');
                    tbody.innerHTML = '';

                    // 1. Jika data berupa Error (bukan Array)
                    if (data.error) {
                        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:red;">‚ùå Error: ${data.error}</td></tr>`;
                        return;
                    }

                    // 2. Jika data bukan Array (Jaga-jaga)
                    if (!Array.isArray(data)) {
                        console.error("Format data salah:", data);
                        return;
                    }

                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:10px;">Belum ada data gaji.</td></tr>';
                        return;
                    }

                    data.forEach(slip => {
                        const rupiah = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(slip.net_salary);
                        const pajak = new Intl.NumberFormat('id-ID').format(slip.tax_amount);

                        tbody.innerHTML += `
                        <tr style="border-bottom:1px solid #eee;">
                            <td style="padding:10px;">
                                <b>${slip.month}/${slip.year}</b><br>
                                <span style="font-size:11px; color:#555;">Pajak: Rp ${pajak}</span>
                            </td>
                            <td style="padding:10px; text-align:right; color:#27ae60; font-weight:bold;">
                                ${rupiah}
                            </td>
                            <td style="padding:10px; text-align:center;">
                                <button onclick="downloadPDF(${slip.id})" style="padding:5px; font-size:11px; background:#e74c3c; color:white; border:none; border-radius:3px; cursor:pointer;">
                                    üìÑ PDF
                                </button>
                            </td>
                        </tr>
                    `;
                    });
                });
        }

        function loadLeaveHistory() {
                fetch('https://hris-enterprise-production.up.railway.app//api/leave/my-history', {
                    headers: { 'Authorization': 'Bearer ' + token }
                })
                    .then(res => res.json())
                    .then(data => {
                        const tbody = document.getElementById('leave-history-table');
                        tbody.innerHTML = '';

                        if (data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:10px;">Belum ada pengajuan.</td></tr>';
                            return;
                        }

                        data.forEach(req => {
                            let badgeColor = '#999'; // Abu-abu (Pending)
                            if (req.status === 'APPROVED') badgeColor = '#27ae60'; // Hijau
                            if (req.status === 'REJECTED') badgeColor = '#e74c3c'; // Merah

                            tbody.innerHTML += `
                        <tr style="border-bottom:1px solid #eee;">
                            <td style="padding:8px;">${new Date(req.start_date).toLocaleDateString()}</td>
                            <td style="padding:8px;">${req.reason}</td>
                            <td style="padding:8px;">
                                <span style="background:${badgeColor}; color:white; padding:3px 8px; border-radius:10px; font-size:11px; font-weight:bold;">
                                    ${req.status}
                                </span>
                            </td>
                        </tr>
                    `;
                        });
                    });
            }

        // --- FUNGSI ABSENSI (SAMA SEPERTI SEBELUMNYA) ---
        function kirimAbsen(type) {
            fetch(`https://hris-enterprise-production.up.railway.app//api/attendance/${type}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }
            })
                .then(res => res.json())
                .then(data => {
                    const statusEl = document.getElementById('absen-status');
                    if (data.error) {
                        statusEl.innerText = "‚ùå " + data.error;
                        statusEl.style.color = "red";
                    } else {
                        statusEl.innerText = "‚úÖ " + data.message;
                        statusEl.style.color = "green";
                        loadHistory();
                    }
                });
        }

        function loadHistory() {
            fetch('https://hris-enterprise-production.up.railway.app//api/attendance/history', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('history-table');
                tbody.innerHTML = '';
                
                // --- PERBAIKAN UX: JIKA KOSONG ---
                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td style="text-align:center; padding: 20px; color: #888;">
                                üò¥ <b>Belum ada riwayat absensi.</b><br>
                                Jangan lupa klik "MASUK" hari ini ya!
                            </td>
                        </tr>`;
                    return;
                }
                // ---------------------------------

                data.forEach(log => {
                    // Format Jam agar enak dibaca (contoh: 08:30)
                    const masuk = log.clock_in ? new Date(log.clock_in).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '-';
                    const pulang = log.clock_out ? new Date(log.clock_out).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
                    
                    // Kita perbagus dikit tampilannya biar ada info jam pulang juga
                    tbody.innerHTML += `
                        <tr style="border-bottom:1px solid #eee;">
                            <td style="padding:10px;">
                                üìÖ ${new Date(log.date).toLocaleDateString()} <br>
                                üåû Masuk: <b>${masuk}</b> | üåô Pulang: <b>${pulang}</b>
                            </td>
                        </tr>`;
                });
            })
            .catch(err => {
                console.error(err);
                document.getElementById('history-table').innerHTML = '<tr><td style="color:red; text-align:center;">Gagal memuat data.</td></tr>';
            });
        }

        // --- FUNGSI CUTI (BARU!) ---
        function submitLeave() {
            const start_date = document.getElementById('leave-start').value;
            const end_date = document.getElementById('leave-end').value;
            const reason = document.getElementById('leave-reason').value;
            const statusEl = document.getElementById('leave-status');

            if (!start_date || !end_date || !reason) {
                alert("Mohon lengkapi formulir cuti!");
                return;
            }

            statusEl.innerText = "Mengirim...";

            fetch('https://hris-enterprise-production.up.railway.app//api/leave/request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ start_date, end_date, reason })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        statusEl.innerText = "‚ùå " + data.error;
                        statusEl.style.color = "red";
                    } else {
                        statusEl.innerText = "‚úÖ Berhasil dikirim! Tunggu persetujuan Bos.";
                        statusEl.style.color = "green";
                        // Reset form
                        document.getElementById('leave-reason').value = '';
                        loadLeaveHistory();
                    }
                });
        }

        // FUNGSI DOWNLOAD PDF (BARU!)
            function downloadPDF(payrollId) {
                // Kita pakai teknik 'window.open' dengan token di URL (cara cepat)
                // Atau fetch blob (cara aman). Kita pakai fetch blob biar header Auth terbawa.

                const btn = event.target;
                btn.innerText = "‚è≥...";

                fetch(`https://hris-enterprise-production.up.railway.app//api/payroll/${payrollId}/download`, {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + token }
                })
                    .then(res => {
                        if (res.status !== 200) throw new Error("Gagal download");
                        return res.blob(); // Ubah respon jadi File (Blob)
                    })
                    .then(blob => {
                        // Trik download file di browser via JS
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Slip_Gaji_${payrollId}.pdf`;
                        document.body.appendChild(a); // Tempel ke body
                        a.click(); // Klik otomatis
                        a.remove(); // Hapus lagi
                        btn.innerText = "üìÑ PDF"; // Balikin tombol
                    })
                    .catch(err => {
                        alert("Gagal mendownload PDF!");
                        btn.innerText = "‚ùå Err";
                    });
            }

        function logout() {
            localStorage.clear();
            location.reload();
        }
    </script>
</body>

</html>